---

# ТЕЛЕГРАМ-БОТ ДЛЯ ИНТЕРНЕТ-МАГАЗИНА

Этот телеграм-бот разработан для управления и взаимодействия с интернет-магазином на платформе OpenCart. Он включает функционал поиска товаров по различным параметрам, управление дисконтными картами, массовую рассылку и статистику.

## СОДЕРЖАНИЕ

1. [ФУНКЦИОНАЛ БОТА](#1-функционал-бота)
    - 1.1. [СТАРТ](#11-старт)
        - 1.1.1. [СОГЛАСИЕ](#111-согласие)
        - 1.1.2. [ОТКАЗ](#112-отказ)
    - 1.2. [ГЛАВНОЕ МЕНЮ](#12-главное-меню)
        - 1.2.1. [ПОИСК ТОВАРА](#121-поиск-товара)
        - 1.2.2. [ИНФОРМАЦИЯ](#122-информация)
        - 1.2.3. [ПОСЕТИТЬ МАГАЗИН](#123-посетить-магазин)
        - 1.2.4. [ДИСКОНТНАЯ КАРТА](#124-дисконтная-карта)
        - 1.2.5. [БАЛАНС ДИСКОНТНОЙ КАРТЫ](#125-баланс-дисконтной-карты)
        - 1.2.6. [СВЯЗЬ С ОПЕРАТОРОМ](#126-связь-с-оператором)
        - 1.2.7. [ПЕРЕЗАПУСТИТЬ БОТ](#127-перезапустить-бот)
    - 1.3. [МЕНЮ МАРКЕТИНГА](#13-меню-маркетинга)
        - 1.3.1. [МЕНЮ РАССЫЛКИ](#131-меню-рассылки)
        - 1.3.2. [МЕНЮ СТАТИСТИКИ](#132-меню-статистики)
    - 1.4. [УПРАВЛЯЮЩИЕ КОМАНДЫ](#14-управляющие-команды)
        - 1.4.1. [ОСТАНОВКА БОТА](#141-остановка-бота)
        - 1.4.2. [BACKUP](#142-backup)
        - 1.4.3. [ПЕРЕЗАПУСК](#143-перезапуск)
2. [API OPENCART](#2-api-opencart)
3. [ЗАПУСК БОТА](#3-запуск-бота)
    - 3.1. [ЗАПУСК ЧЕРЕЗ MAIN](#31-запуск-через-main)
    - 3.2. [ЗАПУСК ЧЕРЕЗ DOCKER](#32-запуск-через-docker)
4. [TODO](#4-todo)
    - 4.1. [ФУНКЦИОНАЛ](#41-функционал)
    - 4.2. [ТЕСТИРОВАНИЕ](#42-тестирование)
    - 4.3. [РЕФАКТОРИНГ](#43-рефакторинг)
    - 4.4. [ОПТИМИЗАЦИЯ](#44-оптимизация)

---

## 1. ФУНКЦИОНАЛ БОТА

### 1.1. СТАРТ

Пользователь нажимает "ЗАПУСТИТЬ" и его встречает первое меню. Это меню запроса согласия на обработку персональных данных.

#### 1.1.1. СОГЛАСИЕ

Если пользователь нажимает "Согласиться", для него создается [ГЛАВНОЕ МЕНЮ](#12-главное-меню) и он может пользоваться ботом дальше.

#### 1.1.2. ОТКАЗ

Если пользователь нажимает "Не соглашаться", то бот не будет ему выводить какое-либо другое меню, кроме запроса согласия на обработку персональных данных. Пока пользователь не даст согласие, бот будет находиться в этом состоянии.

### 1.2. ГЛАВНОЕ МЕНЮ

После дачи согласия на обработку данных, пользователю выводится приветственное сообщение с кратким описанием кнопок бота.

#### 1.2.1. ПОИСК ТОВАРА

При нажатии кнопки "Поиск товара", пользователь получает сообщение, с тем, что он может искать товар через бот. Он может искать товары следующим образом:
- по словесному описанию, интересующего его товара;
- по коду товара (он же id товара);
- по номеру штрихкода товара;
- по фото штрихкода. Сфотографировать штрихкод товара и отправить его не убирая галочку "Сжать изображение".

#### 1.2.2. ИНФОРМАЦИЯ

При нажатии кнопки "Информация", пользователь получает сообщения, в которых подробно описано, как пользоваться ботом.
- Первое сообщение рассказывает, как пользоваться поиском товаров и зачем кнопка [ПОИСК ТОВАРА](#121-поиск-товара);
- второе сообщение говорит, как управлять хранением дисконтных карт и зачем кнопка [ДИСКОНТНАЯ КАРТА](#124-дисконтная-карта);
- третье сообщение говорит о том, зачем кнопка [ПЕРЕЗАПУСТИТЬ БОТ](#127-перезапустить-бот).

#### 1.2.3. ПОСЕТИТЬ МАГАЗИН

При нажатии кнопки "Посетить магазин", пользователю выводится два сообщения. Первое сообщение содержит в себе ссылку для перехода на интернет-магазин, второе сообщение содержит в себе адреса, время работы и телефоны магазинов.

#### 1.2.4. ДИСКОНТНАЯ КАРТА

При нажатии кнопки "Дисконтная карта", пользователю выводится сообщение, о том, что он может ввести вручную номер дисконтной карты или отправить фото штрихкода дисконтной карты. Второе сообщение содержит в себе ссылку для ознакомления с дисконтной программой интернет-магазина.

После отправки номера штрихкода дисконтной карты, бот присылает сообщение пользователю, в котором содержится сгенерированное изображение штрихкода карты с номером и текст с названием карты, сроком действия. Бот закрепляет это сообщение для пользователя в чате, чтобы пользователь мог получить быстрый доступ к штрихкоду при оплате на кассе в магазине. Пользователь может добавить несколько карт. Также, он может открепить не нужные ему карты.

#### 1.2.5. БАЛАНС ДИСКОНТНОЙ КАРТЫ

Если пользователь является обладателем дисконтной карты "Мастер", то у него есть накопленные баллы (рубли), которые он может потратить. Бот предоставляет функционал для просмотра этого баланса при нажатии кнопки "Баланс Д.К. Мастер".

#### 1.2.6. СВЯЗЬ С ОПЕРАТОРОМ

Существует две кнопки "Задать вопрос оператору" и "Ответить на вопросы".

Кнопка "Задать вопрос оператору" предназначена для пользователя, который является покупателем. После нажатия этой кнопки, пользователь может написать любой интересующий его вопрос или вопросы и отправить их. После чего сообщение приходит в чат оператору (живой человек), который в реальном времени отвечает на вопросы покупателей. Сообщения от покупателей приходят в чат к оператору в формате - id пользователя, id сообщения, текст сообщения, имя пользователя. Для того чтобы оператор мог ответить на вопросы, ему нужно нажать кнопку "Ответить на вопросы". После этого он выбирает сообщение, на которое хочет ответить, нажимает на него правой кнопкой мыши (или зажимает, если это смартфон), нажимает "ответить" (это функционал телеграм), пишет ответ и отправляет. Он может отвечать подряд на все сообщения. Покупатель также может писать вопросы не нажимая каждый раз кнопку "Задать вопрос". Слова от пользователей, содержащие в себе нецензурную брань (в стандартной форме) форматируются звездочками.

#### 1.2.7. ПЕРЕЗАПУСТИТЬ БОТ

Кнопка "Перезапустить бот" предназначена для того, чтобы пользователь при обновлении функционала бота мог её нажать и у него обновились возможности. Её нажатие при обычных обстоятельствах ничего не меняет. При нажатии кнопки возвращается главное меню бота.

### 1.3. МЕНЮ МАРКЕТИНГА

Меню маркетинга вызывается специальной командой. Доступ к меню маркетинга ограничен не только специфической командой, также он ограничен определенным списком id пользователей, которые могут пользоваться функционалом для маркетинга. Эти id и команда прописываются в конфигурационном файле `configs.env`.

#### 1.3.1. МЕНЮ РАССЫЛКИ

Меню рассылки предназначено для создания групповых рассылок. Там возможно создание рассылки всем пользователям телеграм-бота, а также отдельно. Разделение рассылки сформировано через деление пользователей, использующих дисконтные карты, и не использующих дисконтные карты. Если пользователи имеют дисконтные карты, разделение идет по видам дисконтных карт. Однако, индивидуальной рассылки нет. Возможно, она появится в [будущем](#4-todo). Рассылать можно текст, фото, видео.

#### 1.3.2. МЕНЮ СТАТИСТИКИ

Меню статистики предназначено для вывода основной статистики в чат по пользователям, кликам, основным запросам от пользователей, времени поиска и пр. Также, там можно сформировать файл Excel, который выгрузится в чат и его можно будет скачать. [Некоторые функции находятся на стадии разработки, некоторые требуют исправления](#4-todo).

### 1.4. УПРАВЛЯЮЩИЕ КОМАНДЫ

Как такового меню управляющих команд нет. Команды имеют своё название и они выполняются только если id пользователя прописан в `configs.env`.

#### 1.4.1. ОСТАНОВКА БОТА

Команда предназначена для полной остановки бота.

#### 1.4.2. BACKUP

Команда предназначена для выгрузки в чат бэкапов баз данных и файлов json, которые использует бот для последующего их восстановления. В [будущем](#4-todo) планируется отправка на электронную почту.

#### 1.4.3. ПЕРЕЗАПУСК

Команда предназначена для отправки всем пользователям бота информационного сообщения, которое говорит, что в бот были внесены изменения и для использования нового функционала следует нажать кнопку ["Перезапустить бот"](#127-перезапустить-бот).

## 2. API OPENCART

Для связи с интернет-магазином требуется заранее позаботиться о наличии соответствующих таблиц в базе данных, а именно (таблица покупателей, таблицы продуктов, таблицы дисконтных карт). В соответствии с этими таблицами вам нужно реализовать функционал для поиска товара на сайте. Также вам следует написать функционал для связи бота с сайтом (API).

Примеры контроллеров API могут выглядеть так:

`login`
```php
<?php
class ApiLoginController extends Controller {
    public function handle() {
        $this->load->language('api/login');

        $responseJson = array();

        $this->load->model('account/api');

        $apiDetails = $this->model_account_api->getApiByKey($this->request->post['api_key']);

        if ($apiDetails) {
            $ipData = array();

            $results = $this->model_account_api->getApiIps($apiDetails['api_id']);

            foreach ($results as $result) {
                $ipData[] = trim($result['ip_address']);
            }

            if (!in_array($this->request->server['REMOTE_ADDR'], $ipData)) {
                $responseJson['error']['ip'] = sprintf($this->language->get('error_ip'), $this->request->server['REMOTE_ADDR']);
            }

            if (!$responseJson) {
                $responseJson['success'] = $this->language->get('text_success');

                $oldSessionId = $this->session->getId();

                $newSessionId = $this->session->createId();

                $this->session->start('api', $newSessionId);

                $this->session->data['api_id'] = $apiDetails['api_id'];

                $this->session->start('default');

                $responseJson['token'] = $this->model_account_api->addApiSession($apiDetails['api_id'], $newSessionId, $this->request->server['REMOTE_ADDR']);
            } else {
                $responseJson['error']['key'] = $this->language->get('error_key');
            }
        }

        if (isset($this->request->server['HTTP_ORIGIN'])) {
            $this->response->addHeader('Access-Control-Allow-Origin: ' . $this->request->server['HTTP_ORIGIN']);
            $this->response->addHeader('Access-Control-Allow-Methods: GET, PUT, POST, DELETE, OPTIONS');
            $this->response->addHeader('Access-Control-Max-Age: 1000');
            $this->response->addHeader('Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With');
        }

        $this->response->addHeader('Content-Type: application/json');
        $this->response->setOutput(json_encode($responseJson));
    }
}
```

`product`
```php
<?php
class ApiProductController extends Controller {
    public function fetchProductById() {
        if (!isset($this->request->get['product_id'])) {
            $this->response->addHeader('Content-Type: application/json');
            $this->response->setOutput(json_encode(['error' => 'Missing search parameter']));
            return;
        }

        $productId = $this->request->get['product_id'];

        $this->load->model('catalog/product');

        $productDetails = $this->model_catalog_product->getProduct($productId);

        $this->response->addHeader('Content-Type: application/json');
        $this->response->setOutput(json_encode($productDetails));
    }

    public function fetchProductAttributesById() {
        if (!isset($this->request->get['product_id'])) {
            $this->response->addHeader('Content-Type: application/json');
            $this->response->setOutput(json_encode(['error' => 'Missing search parameter']));
            return;
        }

        $productId = $this->request->get['product_id'];

        $this->load->model('catalog/product');

        $productAttributes = $this->model_catalog_product->getProductAttributes($productId);

        $this->response->addHeader('Content-Type: application/json');
        $this->response->setOutput(json_encode($productAttributes));
    }

    public function fetchProductQuantityById() {
        if (!isset($this->request->get['product_id'])) {
            $this->response->addHeader('Content-Type: application/json');
            $this->response->setOutput(json_encode(['error' => 'Missing search parameter']));
            return;
        }

        $productId = $this->request->get['product_id'];

        $this->load->model('catalog/product');

        $productQuantity = $this->model_catalog_product->getQuantity($productId);

        $this->response->addHeader('Content-Type: application/json');
        $this->response->setOutput(json_encode($productQuantity));
    }
}
```

`search`
```php
<?php
class ApiSearchController extends Controller {
    public function searchProducts() {
        if (!isset($this->request->get['search_query'])) {
            $this->response->addHeader('Content-Type: application/json');
            $this->response->setOutput(json_encode(['error' => 'Missing search parameter']));
            return;
        }

        $searchQuery = $this->request->get['search_query'];
        $decodedSearchQuery = '';
        if (isset($searchQuery)) {
            $decodedSearchQuery = urldecode($searchQuery);
        }

        $this->load->model('catalog/product');
        $searchResults = $this->model_catalog_product->getSearch($decodedSearchQuery);

        foreach ($searchResults as $key => $row) {
            $searchResults[$key]['url'] = $this->url->link('product/product', 'product_id=' . $key);
        }

        $this->response->addHeader('Content-Type: application/json');
        $this->response->setOutput(json_encode($searchResults));
    }

    
```

`card`
```php
<?php
class ApiCardController extends Controller {
    public function fetchCustomerByCard() {
        $this->load->language('api/customer');

        $this->load->model('account/customer');

        $cardNumber = $this->request->get['card_number'];

        $customerInfo = $this->model_account_customer->getCustomerByCard($cardNumber);

        $this->response->addHeader('Content-Type: application/json');

        if ($customerInfo) {
            $this->response->setOutput(json_encode($customerInfo));
        } else {
            $this->response->setOutput(json_encode(['error' => 'Customer not found']));
        }
    }
}
```

## 3. ЗАПУСК БОТА

Есть несколько вариантов запустить этот телеграм-бот.

### 3.1. ЗАПУСК ЧЕРЕЗ MAIN

Заранее подготовьте среду разработки, установить Python версии не ниже 3.12.x

```bash
sudo apt install python3.12
```

Создайте отдельную папку на ПК.

```bash
mkdir my_bot_folder
cd my_bot_folder
```

Создайте виртуальное окружение.

```bash
python -m venv test_env
```

Запустите виртуальное окружение.

```bash
source test_env/bin/activate
```

Склонируйте репозиторий себе на ПК в соответствующую директорию.

```bash
git clone https://github.com/username/repository.git
```

Внесите соответствующие изменения в конфигурационный файл `configs.env`.

Установите все библиотеки из файла `requirements.txt`.

```bash
pip install -r requirements.txt
```

Откройте консоль и запустите файл `main.py`.

```bash
python main.py
```

### 3.2. ЗАПУСК ЧЕРЕЗ DOCKER

Для запуска телеграм-бота рекомендуется использовать Docker.

Установите Docker.

Склонируйте репозиторий к себе на ПК.

```bash
git clone https://github.com/username/repository.git
```

Внесите соответствующие изменения в конфигурационный файл `configs.env`.

Создайте Docker образ.

```bash
docker build -t telegram-bot-test .
```

Запустите Docker контейнер.

```bash
docker run -d --name telegram-bot-test-container telegram-bot-test
```

UPD: При работе с изображениями, возможно потребуется установка соответствующих библиотек на ПК.

## 4. TODO

### 4.1. ФУНКЦИОНАЛ
- [ ] 4.1.1. Доработать функционал формирования статистики;
- [ ] 4.1.2. Исправить формирование статистики по количеству пользователей;
- [ ] 4.1.3. Написать функционал для отправки бэкапа на почту раз в неделю;
- [ ] 4.1.4. Добавить возможность загрузки и обновления баз данных из бота;
- [x] 4.1.5. ~~Добавить защиту защиту от DoS аттак~~;
### 4.2. ТЕСТИРОВАНИЕ
- [ ] 4.2.1. Написать тесты для бота (pytest).
### 4.3. РЕФАКТОРИНГ
- [ ] 4.3.1. Пересмотреть количество функций в модулях;
- [ ] 4.3.2. Уменьшить количество повторений в коде;
- [ ] 4.3.3. Исправить синтаксические ошибки;
- [ ] 4.3.4. Удалить неиспользуемые части кода;
- [x] 4.3.5. ~~Переделать структуру проекта.~~
 ### 4.4. ОПТИМИЗАЦИЯ
- [ ] 4.4.1. Ускорить функции запросов к API.

---
